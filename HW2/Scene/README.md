<center><h1>Scene 交互手册</h1></center>
<div style="text-align:right;">软件52 陈书新 2015013229</div>

## 0. 了解 Scene

Scene 是由 OpenGL 渲染的一个场景，由以下物体组成：

- 一个球体
- 一个正方体
- 一个圆柱体
- 六面墙

六面墙限制了场景的边界为 [-1.0f, 1.0f] ^ 3。  
为了不让相机碰到边界，相机的移动范围为 [-0.9975f, 0.9975f] ^ 3。

## 1. 场景构建

场景的模型在 `model` 目录下，请勿随意更改。  
Scene 中的很多参数可以修改，从而实现不同的效果。  
所有的参数保存在 `scene.zerotrac` 中，在 2.1，2.3 会介绍这些参数。

## 2. 绘制场景

### 2.1 Phong 模型

简化了 Phong 模型的参数，每个物体对于 Phong 模型中每个部分的光使用同一个反射系数。  
参数说明：

- `sphere _r _g _b` 表示球体三色的反射系数。
- `cube _r _g _b` 表示正方体三色的反射系数。
- `cylinder _r _g _b` 表示圆柱体三色的反射系数。
- `wall _id _r _g _b` 表示编号为 `_id` 的墙三色的反射系数。其中 0, 1, 2, 3, 4, 5 分别表示 -y, +z, -x, -z, +x, +y = 1.0 的墙。
- `f obj _f` 表示物体镜面反射余弦值的系数。
- `f wall _f` 表示墙镜面反射余弦值的系数。
- `enviro _r _g _b` 表示环境光强，注意不要设的太大。
- `light _x _y _z _r _g _b` 表示一个点光源。前三个参数表示位置，这里没有 [-1.0f, 1.0f] 的限制，因此可以用很大的数近似平行光源。后三个参数表示光强。注意最多支持 5 个光源，多出的光源会依次覆盖最早的光源。

不支持的参数不会有任何作用，因此可以用 `//` 注释不想要的参数。  
不可以修改的参数例如物体的大小、位置等。

### 2.2 投影模式

按鼠标右键切换投影模式。  
在正投影模式下只有最底部的墙（-y = 1）会显示。  
否则就场景穿透了。

### 2.3 纹理映射

图像纹理：使用 `T` 键切换预设的颜色参数和纹理，在使用纹理时 Phong 模型同样适用。  
参数说明：

- `tex _name` 表示使用 `texture` 目录下文件名为 `_name` 的纹理。

几何纹理：不会写，而且模型点数不是很多也没法写。。。

### 2.4 阴影

实时的阴影写了很久调不出来，放弃了。  
非实时的阴影见 4.1。

## 3. 场景漫游

相机坐标同构于 R ^ 3 * SO(3)，有六个自由度，至少需要 12 个键才能自由控制。  
因此我决定取消一个转动自由度，让相机无法绕 z 轴旋转（相当于让一个人不歪着头看东西）。  
设当前相机朝向为 v，那么使用 `W` 和 `S` 以 v 方向前后移动，使用 `A` 和 `D` 以 v 和 y 轴叉积的方向左右移动，使用 `Q` 和 `E` 以 y 轴方向上下移动。按住鼠标左键并拖动来改变视角。这样就实现了一个五个自由度的相机。  
注意相机有移动范围限制，见 0。

## 3.1 移动相机

### 3.2 碰撞检测
	
用 AABB 检测，使相机无法穿透物体。

## 4. 渲染

### 4.0 重要说明

光线追踪我实现了新的自定义场景，2.1 支持的东西太少了。例如不支持物体的大小、位置、数量等。  
因此光线追踪出来的结果和在 OpenGL 中看到的结果是不一样的，要自己写场景，场景边界不变。
	
场景文件在 `raytracing` 目录下，`setting.txt` 和 `objects.txt`。

首先讲 `settings.txt`。  

- `cube x` `cylinder x` `sphere x` 可以自定义正方体、圆柱体、球的个数。  
- 墙不变，无法自定义数量。
- 相机固定为透视投影。
- 相机位置为 (0, 0, `m` + `n`)。
- 投影屏位置为 (0, 0, `n`)。
- 投影屏的高度的一半为 `t`。
- 分辨率为 `size` * `size`，光线追踪的迭代次数为 `depth`。
- 注意 `t` 必须小于 1，不然投影屏就比场景还要大。
- 注意 (`m` + `n`) / `m` * `t` 也要小于 1，不然就会有光线追踪到场景外了。

然后讲 `objects.txt`。最常用的命令为 `<obj> <id> <attr> ...`，用来设置某个物体的参数。

- `<obj>` 可以为 `cube` `cylinder` `sphere` `wall`。
- `<attr>` 可以为 `material` `f` `scale` `translate` `opaque`，分别表示反射系数，反射余弦值系数，设置缩放，设置平移，设置透明。
- `material` `f` 类似 2.1。
- `scale` `translate` 注意先后顺序，因为 `scale` 是原点缩放。同时要注意不要把物体移出场景。
- `opaque` 表示不允许物体镜面反射，更好地模拟一面墙。

除此之外的命令还有：

- `environment illumiation` 设置环境光。
- `light position x y z illumiation r g b` 设置点光源。点光源的数目没有限制。

### 4.1 光线追踪

使用 `R` 开始模拟光线追踪，再次提醒光线追踪的结果与在 OpenGL 中看到的场景无关。  
模拟时会阻塞当前进程，时间再一分钟以内，结果保存在 `raytracing` 目录下的 `hey.jpg`。  
光学追踪可以很好地模拟阴影。  
写了法向量插值让渲染看起来连续一些。

### 4.2 修改参数

Phong 模型见 2.1。  
光线追踪见 4.0。

## 5. 吐槽

这小（da）作业对出国党太不友好了。。。  
正好卡在申请季非常忙的时候。。。  
感觉要失学了。。。